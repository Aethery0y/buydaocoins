(()=>{var e={};e.id=613,e.ids=[613],e.modules={62849:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=62849,e.exports=r},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},35816:e=>{"use strict";e.exports=require("process")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},74026:e=>{"use strict";e.exports=require("string_decoder")},95346:e=>{"use strict";e.exports=require("timers")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},57300:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>_,patchFetch:()=>P,requestAsyncStorage:()=>y,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{POST:()=>l});var o=t(49303),a=t(88716),n=t(60670),i=t(87070),u=t(75571),c=t(90455),p=t(19687);async function l(e){let r=null;try{let t,s,o;try{t=await e.json()}catch(e){return i.NextResponse.json({error:"Invalid request body"},{status:400})}let{orderId:a,discordId:n,server:l}=t,d=await (0,u.getServerSession)(c.L),y=d?.user?.id||n;if(!y)return i.NextResponse.json({error:"Unauthorized"},{status:401});let f=y.replace(/[^\w-]/g,"");if(!f||f!==y)return console.error("Invalid user ID format:",y),i.NextResponse.json({error:"Invalid user session"},{status:401});if(!a||"string"!=typeof a)return i.NextResponse.json({error:"Order ID required"},{status:400});let m=a.replace(/[^\w-]/g,"");if(!m||m.length<10)return i.NextResponse.json({error:"Invalid order ID format"},{status:400});let _=l||"S0",P=await p.d_.getConnection(),x=null;try{let[e]=await P.execute("SELECT * FROM paypal_order_metadata WHERE order_id = ? AND expires_at > NOW() LIMIT 1",[m]);e.length>0&&(x=e[0])}finally{P.release()}let v=(0,p.o_)(_);r=await v.getConnection();let[E]=await r.execute("SELECT id, user_id FROM dao_transactions WHERE description LIKE ? LIMIT 1",[`%PayPal Order ${m}%`]);if(E.length>0){if(E[0].user_id===f)return console.warn("Duplicate capture attempt for order:",m),i.NextResponse.json({error:"This order has already been processed"},{status:409});return console.error("Order ID collision detected:",m),i.NextResponse.json({error:"Invalid order"},{status:400})}let g=process.env.PAYPAL_CLIENT_ID,h=process.env.PAYPAL_CLIENT_SECRET;if(!g||!h)return console.error("PayPal credentials not configured"),i.NextResponse.json({error:"Payment system not configured"},{status:500});let R=process.env.PAYPAL_MODE||"sandbox",O=Buffer.from(`${g}:${h}`).toString("base64"),j=new AbortController,b=setTimeout(()=>j.abort(),3e4);try{s=await fetch(`${"live"===R?"https://api-m.paypal.com":"https://api-m.sandbox.paypal.com"}/v2/checkout/orders/${m}/capture`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${O}`},signal:j.signal})}catch(e){if(clearTimeout(b),"AbortError"===e.name)return console.error("PayPal capture timeout"),i.NextResponse.json({error:"Payment verification timeout. Please contact support if payment was deducted."},{status:504});return console.error("PayPal capture request failed:",e),i.NextResponse.json({error:"Failed to verify payment"},{status:500})}clearTimeout(b);try{o=await s.json()}catch(e){return console.error("Failed to parse PayPal capture response"),i.NextResponse.json({error:"Invalid payment response"},{status:500})}if(!s.ok){if(console.error("PayPal capture error:",o),"UNPROCESSABLE_ENTITY"===o.name&&o.details?.[0]?.issue==="ORDER_ALREADY_CAPTURED")return i.NextResponse.json({error:"This order has already been processed"},{status:409});return i.NextResponse.json({error:"Payment capture failed"},{status:500})}if("COMPLETED"!==o.status)return console.error("PayPal order not completed:",o),i.NextResponse.json({error:"Payment not completed"},{status:400});if(!o.purchase_units||!Array.isArray(o.purchase_units)||0===o.purchase_units.length)return console.error("Invalid PayPal response structure - no purchase units:",JSON.stringify(o,null,2)),i.NextResponse.json({error:"Invalid payment data"},{status:500});let w=o.purchase_units[0],N=w?.payments?.captures?.[0];if(!N||!N.amount?.value)return console.error("Invalid PayPal response structure - no capture data:",JSON.stringify(o,null,2)),i.NextResponse.json({error:"Invalid payment data"},{status:500});if(!function(e){if("string"!=typeof e&&"number"!=typeof e)return!1;let r=parseFloat(String(e));return!isNaN(r)&&!!isFinite(r)&&!(r<1)&&!(r>1e4)}(N.amount.value))return console.error("Invalid amount in PayPal response:",N.amount.value),i.NextResponse.json({error:"Invalid payment amount"},{status:500});if("COMPLETED"!==N.status)return console.error("Capture status not completed:",N.status),i.NextResponse.json({error:"Payment not completed"},{status:400});let D=parseFloat(N.amount.value);if(!x)return console.error("Order metadata not found:",m),i.NextResponse.json({error:"Order data not found. Please try creating a new order."},{status:400});if(Math.abs(x.amount-D)>.01){console.error("Payment amount mismatch:",{expected:x.amount,actual:D});let e=await p.d_.getConnection();try{await e.execute("DELETE FROM paypal_order_metadata WHERE order_id = ?",[m])}finally{e.release()}return i.NextResponse.json({error:"Payment amount verification failed"},{status:400})}let S=x.base_coins,T=x.bonus_coins,I=x.coupon_code,A=null;if(x.packages)try{let e=JSON.parse(x.packages);A=e&&e.length>0?e.map(e=>e.type).join(", "):null}catch(e){console.error("Error parsing packages JSON:",e)}let q=S+T;if(q<=0)return console.error("Invalid DAO coins calculation:",{amountPaid:D,baseCoins:S,bonusCoins:T,totalCoins:q}),i.NextResponse.json({error:"Invalid payment amount"},{status:500});try{await r.beginTransaction();let[e]=await r.execute("SELECT id, dao_coins FROM players WHERE id = ? FOR UPDATE",[f]);if(0===e.length)return await r.rollback(),i.NextResponse.json({error:"Player not found"},{status:404});await r.execute("UPDATE players SET dao_coins = dao_coins + ?, dao_coins_spent = dao_coins_spent + ? WHERE id = ?",[q,q,f]),I&&await r.execute("UPDATE dao_coupons SET current_uses = current_uses + 1 WHERE code = ?",[I]);let t=`Web purchase - PayPal Order ${m} - $${D.toFixed(2)}`;T>0&&I&&(t+=` (Coupon: ${I}, Bonus: +${T} coins)`),await r.execute("INSERT INTO dao_transactions (user_id, amount, type, description, coupon_code, bonus_coins, package_type) VALUES (?, ?, ?, ?, ?, ?, ?)",[f,q,"web_purchase",t,I,T,A]),await r.commit();let s=await p.d_.getConnection();try{await s.execute("DELETE FROM paypal_order_metadata WHERE order_id = ?",[m])}finally{s.release()}return console.log(`[PAYPAL CAPTURE] Success: ${q} DC for user ${f} on server ${_}`),i.NextResponse.json({success:!0,daoCoins:q,baseCoins:S,bonusCoins:T,couponCode:I,transactionId:o.id,server:_})}catch(e){console.error("Database error during transaction:",e);try{await r.rollback()}catch(e){console.error("Rollback failed:",e)}return i.NextResponse.json({error:"Failed to process payment. Please contact support with order ID: "+m},{status:500})}}catch(e){return console.error("Error capturing PayPal order:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}finally{r&&r.release()}}let d=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/paypal/capture-order/route",pathname:"/api/paypal/capture-order",filename:"route",bundlePath:"app/api/paypal/capture-order/route"},resolvedPagePath:"/var/www/buydaocoins.aethexiz.com/app/api/paypal/capture-order/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:m}=d,_="/api/paypal/capture-order/route";function P(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},90455:(e,r,t)=>{"use strict";t.d(r,{L:()=>s});let s={providers:[(0,t(19475).Z)({clientId:process.env.CLIENT_ID,clientSecret:process.env.CLIENT_SECRET})],callbacks:{session:async({session:e,token:r})=>(e.user&&(e.user.id=r.sub),e)},pages:{signIn:"/"}}},9487:(e,r,t)=>{"use strict";t.d(r,{Z:()=>s});let s=t(73785).createPool({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,waitForConnections:!0,connectionLimit:10,queueLimit:0})},6652:(e,r,t)=>{"use strict";t.d(r,{Z:()=>s});let s=t(73785).createPool({host:process.env.DB_HOST_DS1,user:process.env.DB_USER_DS1,password:process.env.DB_PASSWORD_DS1,database:process.env.DB_NAME_DS1,waitForConnections:!0,connectionLimit:10,queueLimit:0})},19687:(e,r,t)=>{"use strict";t.d(r,{d_:()=>s.Z,o_:()=>a});var s=t(9487),o=t(6652);function a(e){return"DS1"===e?o.Z:s.Z}},69955:(e,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0})},75571:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0});var s={};Object.defineProperty(r,"default",{enumerable:!0,get:function(){return a.default}});var o=t(69955);Object.keys(o).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(s,e))&&(e in r&&r[e]===o[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return o[e]}}))});var a=function(e,r){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=n(void 0);if(t&&t.has(e))return t.get(e);var s={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&({}).hasOwnProperty.call(e,a)){var i=o?Object.getOwnPropertyDescriptor(e,a):null;i&&(i.get||i.set)?Object.defineProperty(s,a,i):s[a]=e[a]}return s.default=e,t&&t.set(e,s),s}(t(45609));function n(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(n=function(e){return e?t:r})(e)}Object.keys(a).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(s,e))&&(e in r&&r[e]===a[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return a[e]}}))})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,972,694,785],()=>t(57300));module.exports=s})();