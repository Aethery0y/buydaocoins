"use strict";(()=>{var e={};e.id=839,e.ids=[839],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},2172:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>h,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>P,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>c});var o=r(49303),a=r(88716),n=r(60670),i=r(87070),u=r(45609),p=r(90455);async function c(e){let t="live"===process.env.PAYPAL_MODE?"https://api-m.paypal.com":"https://api-m.sandbox.paypal.com";try{let{token:r,discordId:s}=await e.json(),o=await (0,u.getServerSession)(p.L),a=o?.user?.id||s;if(!a)return i.NextResponse.json({message:"Unauthorized",error:"Not authenticated"},{status:401});if(!r||"string"!=typeof r||0===r.length)return i.NextResponse.json({message:"Invalid token"},{status:400});let n=process.env.PAYPAL_CLIENT_ID,c=process.env.PAYPAL_CLIENT_SECRET;if(!n||!c)return console.error("[PAYMENT CAPTURE] Missing PayPal credentials"),i.NextResponse.json({message:"Payment configuration error"},{status:500});let d=Buffer.from(`${n}:${c}`).toString("base64"),l=await fetch(`${t}/v1/oauth2/token`,{method:"POST",headers:{Authorization:`Basic ${d}`,"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=client_credentials"});if(!l.ok){let e=await l.text();return console.error("[PAYMENT CAPTURE] PayPal token error:",e),i.NextResponse.json({message:"Payment authentication failed"},{status:500})}let{access_token:m}=await l.json(),P=await fetch(`${t}/v2/checkout/orders/${r}`,{method:"GET",headers:{Authorization:`Bearer ${m}`,"Content-Type":"application/json"}});if(!P.ok)return console.error("[PAYMENT CAPTURE] Failed to get order details"),i.NextResponse.json({message:"Payment verification failed"},{status:500});let x=await P.json(),h=x.purchase_units?.[0]?.custom_id;if(!h)return console.error("[PAYMENT CAPTURE] No custom_id in order details"),i.NextResponse.json({message:"Invalid payment data"},{status:400});let y=await fetch(`${t}/v2/checkout/orders/${r}/capture`,{method:"POST",headers:{Authorization:`Bearer ${m}`,"Content-Type":"application/json"},body:JSON.stringify({})});if(!y.ok){let e=await y.text();if(!e.includes("ORDER_ALREADY_CAPTURED"))return console.error("[PAYMENT CAPTURE] PayPal capture error:",e),i.NextResponse.json({message:"Payment capture failed"},{status:500});console.log("[PAYMENT CAPTURE] Order already captured - proceeding with activation")}let g={};if(y.ok){if(g=await y.json(),"COMPLETED"!==g.status)return console.error("[PAYMENT CAPTURE] Order not completed:",g.status),i.NextResponse.json({message:"Payment not completed"},{status:400})}else g=x;let[T,f]=h.split(":");if(!["autorenew","dao_coins"].includes(T))return console.error("[PAYMENT CAPTURE] Invalid item type:",T),i.NextResponse.json({message:"Invalid purchase type"},{status:400});if(f!==a)return console.error("[PAYMENT CAPTURE] User ID mismatch:",f,"vs",a),i.NextResponse.json({message:"Unauthorized payment"},{status:403});if("autorenew"===T){let e=new URL("/api/admin/activate-autorenew",process.env.NEXTAUTH_URL||"http://localhost:5000"),t=await fetch(e.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a,paymentId:r,amount:g.purchase_units?.[0]?.amount?.value})});if(!t.ok)return console.error("[PAYMENT CAPTURE] Activation failed:",await t.text()),i.NextResponse.json({message:"Purchase activation failed"},{status:500})}return console.log(`[PAYMENT CAPTURE] Success: ${T} for user ${a}`),i.NextResponse.json({status:"success",message:"Payment captured and purchase activated successfully!",orderId:r,itemType:T})}catch(e){return console.error("[PAYMENT CAPTURE] Error:",e instanceof Error?e.message:String(e)),i.NextResponse.json({message:"Payment processing failed"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payment/capture-order/route",pathname:"/api/payment/capture-order",filename:"route",bundlePath:"app/api/payment/capture-order/route"},resolvedPagePath:"/var/www/buydaocoins.aethexiz.com/app/api/payment/capture-order/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:P}=d,x="/api/payment/capture-order/route";function h(){return(0,n.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:m})}},90455:(e,t,r)=>{r.d(t,{L:()=>s});let s={providers:[(0,r(19475).Z)({clientId:process.env.CLIENT_ID,clientSecret:process.env.CLIENT_SECRET})],callbacks:{session:async({session:e,token:t})=>(e.user&&(e.user.id=t.sub),e)},pages:{signIn:"/"}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,694],()=>r(2172));module.exports=s})();